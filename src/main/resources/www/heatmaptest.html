<htm>

<head>
    <script src="jquery.js"></script>
    <script src="heatmap.js"></script>
    <script src="bootstrap.js"></script>
    <script src="d3.min.js"></script>
    <script src="typehead.js"></script>
    <script src="gm/metricsgraphics.js"></script>
    <script src="cubism.telemetry.js"></script>
    <link href="bootstrap.css" rel="stylesheet" type="text/css"></link>
    <link href="gm/metricsgraphics.css" rel="stylesheet" type="text/css"></link>    
    <link href="style.css" rel="stylesheet" type="text/css"></link>

    <style>
        
        #canv_holder {
            clear:both;
            float:right;
            width:600px;
        }
        #line-chart {
            position: relative;
            margin-top: 30px;
        }
        .viz-title {
            color: #666666;
            font-size: 200%;    
        }
        header {
            padding-left: 50px;
            border-bottom-color: #f2f2f2;
            border-bottom-width: 1;
            border-top-color: #990000;
            border-top-width: 3;
            border-bottom-style: solid;
            border-top-style: solid;
        }
        header h3 {
            font-weight: 100; 
            font-size: 21px;
            color: #333333;
            margin: 10;
        }
        .search-box {
            font-size : 14px;  line-height : 24px;  letter-spacing : 0.49px;
        }
        .search-box-holder {
            font-size: 0;
            margin: 20px;
        }
        .to {
            padding-left: 10px; 
        }
        .from {
            padding-left: 10px; 
        }
        .telemetry-label {
            position: relative;
            top: -20;
            left: 20;
            color: #666666;
        }
        
    </style>
</head>

<body>
    <header>
        <h3><img style="margin-left: 25px; margin-right: 25px" src="img/Cisco_logo_2006.png" height="60"> <span>Latency Monitoring System</span></h3>
    </header>
    <div class="row">
        <div class="col-md-6">
            <div id="canv_holder" style="margin: 20px;">
            </div>
        </div>
        <div class="col-md-6">
            <div class="search-box-holder">
                <input type="text" class="typehead from search-box"  width="20"><input type="text" class="typehead to search-box" width="20">
            </div>
            <div class="telemetry-panel">
                <div id="latency_viz"></div>
                <div class="telemetry-label" style="top: -50">Latency</div>
                
                <div id="hos1-telemetry-cpu"></div>
                <div class="telemetry-label">CPU</div>
                
                <div id="hos1-telemetry-mem"></div>
                <div class="telemetry-label">RAM</div>
                
                <div id="hos2-telemetry-cpu"></div>
                <div class="telemetry-label">CPU</div>
                
                <div id="hos2-telemetry-mem"></div>
                <div class="telemetry-label">RAM</div>
            </div>
        </div>
    </div>
    
</body>
    
<script>
  
    

    function authority() {
        var url = window.location.href;
        if (url.startsWith("file")) {
            return "http://localhost:9000"
        } 
        return ""
    }
    
    function updateData(callback) {  
        $.getJSON(authority() + "/nodes", function(nodes) {
            var nodesArr = nodes.map(function(item){ return item._id.addr; });
        
            $.getJSON(authority() + "/edges", function(edges) {
                var edgesArr = edges.map( function(item) {
                    return {
                        from: item._id.source,
                        to: item._id.dest,
                        value: item.last,
                        ts: item.timestamp
                    }
                } );
            
                callback(nodesArr, edgesArr);
            
            } );
        
        }).fail(function( jqxhr, textStatus, error ) {
            var err = textStatus + ", " + error;
            console.log( "Request Failed: " + err );
        });
    };
    
    function TelemetryVisualizer(from, to) {
        $('.telemetry-panel').show('fast');
        
        var sort = encodeURI(JSON.stringify({ time: -1 }));
        var isRunning = true;
        
        var grapthOptions = {
            data: [],
            width: 500,
            height: 100,
            target: '#latency_viz',
            x_accessor: 'time',
            y_accessor: 'latency',
            //title: "Latency",
            transition_on_update: false,
            interpolate: 'linear',
            x_axis: false,
            y_axis: false,
            bottom: 0,
            left: 0,
            top: 10,
            area: false,
            //max_data_size: 100
        };
    
        var fromTime = 0;
        
        function plot(now, startTime) {
            if (!isRunning) {
                return;
            }
            
            var query = encodeURI(JSON.stringify({ source: from, dest: to, time: { $gt: startTime, $lte: now } }));
        
            $.getJSON("http://localhost:9000/db/latency?q=" + query + "&sort=" + sort, function(data) {
                var ltn = data.map(function(item) { 
                    return {
                        time: new Date(item.time),
                        latency: item.pingTotal
                    }
                }).reverse();
                
                grapthOptions.data = ltn;
                MG.data_graphic(grapthOptions);
            });
        
        }
        
        function plotTelemetry(host, selectorCpu, selectorMem, now, startTime) {
            var query = encodeURI(JSON.stringify({ addr: host, timestamp: { $gt: startTime, $lte: now }  }));
            var sort = encodeURI(JSON.stringify({ timestamp: -1 }));
            $.getJSON("http://localhost:9000/db/telemetry?q=" + query + "&sort=" + sort, function(data) {
                if (!!data && data.length > 0) {
                    var ltnCpu = data.map(function(item) {
                        return {
                            date: new Date(item.timestamp),
                            value: Math.floor(item.cpu * 100)
                        }
                    });
                    
                    var ltnMem = data.map(function(item) {
                        return {
                            date: new Date(item.timestamp),
                            value: Math.floor(item.memory)
                        }
                    });
                    
                    MG.data_graphic({
                        data: ltnCpu,
                        width: 500,
                        height: 40,
                        target: selectorCpu,
                        //title: "Latency",
                        transition_on_update: false,
                        interpolate: 'linear',
                        area: true,
                        top: 10,
                        x_axis: false,
                        y_axis: false,
                        bottom: 0,
                        left: 0,
                        buffer: 0,
                        area: false,
                        custom_line_color_map: [2]
                    });
                    
                    MG.data_graphic({
                        data: ltnMem,
                        width: 500,
                        height: 40,
                        target: selectorMem,
                        //title: "Latency",
                        transition_on_update: false,
                        interpolate: 'linear',
                        area: true,
                        x_axis: false,
                        y_axis: false,
                        bottom: 0,
                        left: 0,
                        buffer: 0,
                        top: 10,
                        area: false,
                        custom_line_color_map: [3]
                    });
                }
            }); 
        };
        
        function loop() {
            var now = new Date().getTime();
            if (fromTime == 0) {
                fromTime = now - (1000 * 3600 * 6);
            }
            plot(now, fromTime);
            plotTelemetry(from,"#hos1-telemetry-cpu", "#hos1-telemetry-mem", now, fromTime);
            plotTelemetry(to,"#hos2-telemetry-cpu", "#hos2-telemetry-mem", now, fromTime);
            fromTime = now;
        }
    
        loop();
        var timerId = setInterval(loop, 1000);
    
        this.stop = function() {
            clearInterval(timerId);
            $("#latency_viz").empty();
            $('.telemetry-panel').hide();
        }
    
   }
    
    function selectFromList() {
        var from = $('.from').val();
        var to = $('.to').val();
        
        if (!!from && !!to) {
            showTelemetry(from, to);
            heatmap.select(from, to);
        }
    }
    
    function showTelemetry(from, to) {
        if (!!latencyPlotter)
            latencyPlotter.stop();
        latencyPlotter = new TelemetryVisualizer(from, to);
    }
    
    var latencyPlotter;
    var heatmap = new Heatmap("#canv_holder", 
        {
            size: 600, 
            onclick: function(from, to) {
                $(".from").val(from);
                $(".to").val(to);
                showTelemetry(from, to);
            } 
        }
    );
    
    var oldNodes = "";
    
    function workLoop() {
        updateData(function(nodes, edges) {
            heatmap.update(nodes, edges);
            if ( oldNodes !== nodes.toString() ) {
                $(".typehead").typeahead({source: nodes, afterSelect: selectFromList});
                oldNodes = nodes.toString();
            }
            setTimeout(workLoop, 5000);
        });
    }
    
    //$(".typehead").typeahead();
    
    $('.telemetry-panel').hide();
    
    workLoop();
    
    
</script>
    
</htm>